<html>
<head>
    <title>Find Heavy Dirs</title>
    <style>
        #dataDiv > table td:nth-child(1) {
            text-align: center;
            min-width: 20px;
        }
        #dataDiv > table td:nth-child(2) {
            text-align: right;
            min-width: 100px;
        }
        #dataDiv > table td:nth-child(3) {
            padding-left: 10px
        }
    </style>
</head>
<body onload="onLoad()">
    <button onclick="resetDir()">Top</button>
    <button onclick="upDir()">Up</button>
    <input id="dir" type="text" />
    <input id="limit" type="number" min="1" />
    <hr/>
    <div id="dataDiv" />
    <script type="text/javascript">
        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });

        function onLoad() {
            document.getElementById('dir').value = params.startDir
            document.getElementById('limit').value = params.startLimit
        }

        function resetDir() {
            document.getElementById('dir').value = params.startDir
            updateData()
        }

        function upDir() {
            let el = document.getElementById('dir')
            let dir = el.value
            dir = dir.substring(0, dir.length-tail(dir).length)
            el.value = dir
            updateData()
        }

        function tail(path) {
            const regex = /^.*?[\/]([^\/]+[\/]?)$/
            const found = path.match(regex)
            if (found === null) {
                return ''
            }
            return found[1]
        }

        function updateData() {
            let url = window.location.origin + "/top"
            + "?dir=" + document.getElementById('dir').value
            + "&limit=" + document.getElementById('limit').value

            fetch(url)
            .then(x => x.json())
            .then(x => renderData(x))
        }

        function renderData(data) {
            var myTableDiv = document.getElementById("dataDiv");

            var table = document.createElement('TABLE');
            table.border = '1';

            var tableBody = document.createElement('TBODY');
            table.appendChild(tableBody);

            for (var i = 0; i < data.top.length; i++) {
                let file = tail(data.top[i].path)
                if (file.endsWith('/')) {
                    file = createDirLink(file, data.top[i].path)
                }
                tableBody.appendChild(buildTr(i+1, humanFileSize(data.top[i].size, true), file));
            }
            if (data.rest.size > 0) {
                tableBody.appendChild(buildTr('...', humanFileSize(data.rest.size, true), 'other files...'));
            }
            tableBody.appendChild(buildTr('-', '-', '-'));
            tableBody.appendChild(buildTr('*', humanFileSize(data.total.size, true), data.total.path))
            myTableDiv.replaceChildren(table);
        }

        function buildTr(...values) {
            let tr = document.createElement('TR');

            for(let value of values) {
                let td = document.createElement('TD')
                let node = ['string', 'number'].includes(typeof value) ? document.createTextNode(value) : value
                td.appendChild(node)
                tr.appendChild(td)
            }

            return tr
        }

        function createDirLink(text, path) {
            let a = document.createElement('A')
            a.appendChild(document.createTextNode(text))
            a.onclick = function() {
                document.getElementById('dir').value = path
                updateData()
            }
            return a
        }

        function humanFileSize(bytes, si=false, dp=1) {
            const thresh = si ? 1000 : 1024;

            if (Math.abs(bytes) < thresh) {
                return bytes + ' B';
            }

            const units = si
                ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
                : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
            let u = -1;
            const r = 10**dp;

            do {
                bytes /= thresh;
                ++u;
            } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);


            return bytes.toFixed(dp) + ' ' + units[u];
        }

        setInterval(updateData, 1000)
    </script>
</body>
</html>